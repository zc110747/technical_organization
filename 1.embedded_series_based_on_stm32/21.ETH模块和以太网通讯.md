# **13 ETH模块和TCP/IP应用**
ETH的配置和应用可以说是STM32中最复杂的应用，包含外部的PHY芯片配置，ETH驱动初始化和MAC配置，上层的网络协议栈移植，在完成上述的工作后，才能在协议栈上构建自己的socket或者web应用，单纯靠这一节文章很难讲清楚，这里只能从应用的角度，结合实际使用中遇到的问题，先整体后细节，深入讲解ETH模块功能和TCP/IP应用。<br />
通讯协议的学习其实一直是嵌入式应用中的难点，很多人即使开发出多种涉及网络的产品，仍然不求甚解，我也是在多年的不断的使用，学习和整理后，才有了一套自己的理解，下面进行讲述。通讯协议从简单的理解来说，就是约定不同设备进行交互的一套方法，一般都包含如下结构.<br />

1. 物理层: 定义通讯之间连接的接口，如线缆的数目，检测的电平和转换的周期或频率， 这部分一般由硬件来完成解析和处理。
2. 协议层: 确定数据的格式，如帧头，数据长度，协议版本信息，校验等，基于协议层，可以将两个设备建立逻辑上的连接，从而在多设备互联的情况下实现一对一或多对多的通讯。
3. 应用层: 用于定义具体行业功能需求的应用功能，往往和行业相关，如电源行业一般为电压，电流， 家居行业的温湿度，开关信息。

这个是我理解的协议的三层结构，对于TCP/IP协议栈来说，虽然是4层协议，其中数据链路层对应的就是物理层，网络层和传输层对应协议层，可以建立设备间的连接，应用层则提供网络相关的服务应用，满足应用层的需求，我们对于完整网络应用的开发，也基于这个认知来进行处理， 包含如下步骤。

1. 物理层相关的配置，因为STM32内部只集成了MAC，因此需要和外部的PHY芯片配合才能实现完整的物理层功能，在设计上，PHY芯片通过SMI接口进行配置，通过MII/RMII接口进行交互，完成PHY，GPIO和ETH的驱动配置，即可实现全部物理层的功能。
2. 协议层的移植，