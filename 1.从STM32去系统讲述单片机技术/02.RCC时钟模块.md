# **2. RCC时钟**
RCC是驱动系统运行的基础时钟模块，决定了系统内指令的执行时间，同时也提供系统中各模块运行的工作时钟。对于RCC模块，主要支持以下功能. <br />

1. 管理系统工作的时钟和外设模块时钟频率，让所有模块能够正常工作在相应的时钟频率上。<br />
2. 外设模块的时钟使能，关闭和复位的操作。<br />

## **2.1 时钟源和使能**
对于STM32F4来说，支持内部时钟源LSI(低速内部RC)和HSI(高速内部RC)，其中LSI为32kHz的内部RC振荡器，提供给看门狗工作时钟。HSI则为16MHZ，可以直接提供给系统时钟或通过PLL电路提供给系统时钟。<br />
另外也支持外部时钟源LSE(低速外部时钟源)和HSE(高速外部时钟源)，其中LSE一般为32.768Khz,可用于代替内部LSI，HSE则为25MHz, 可用于代替内部HSI功能。其中HSE可以使用两种晶振，分为有源晶振和无源晶振。<br />

1. 无源晶振是两个引脚的无极性器件，需要配合RC电路(一般为电容配合内部激励时钟)才能产生震荡信号。<br />
2. 有源晶振是完整的振荡器，当正确接入电压后，会有引脚输出产生震荡信号。<br />

内部时钟源具有不依赖外部晶振器件，调试简单等优点，但是会因为设计有误差、温度的影响，相对来说不精确，对于高精度定时，高波特率串口通讯的场景会引入时钟误差，所以有这些功能需求的产品中一般使用外部晶振作为基础时钟源。对于嵌入式RCC开发，主要包含时钟使能，倍频和分频使能，然后将系统时钟，外设模块时钟选中使能的时钟源，下面为HAL库提供的时钟启动和配置的代码。<br />
```c
    RCC_OscInitTypeDef RCC_OscInitStruct = {0};
    RCC_ClkInitTypeDef RCC_ClkInitStruct = {0};

    /** Configure the main internal regulator output voltage
    */
    __HAL_RCC_PWR_CLK_ENABLE();
    __HAL_PWR_VOLTAGESCALING_CONFIG(PWR_REGULATOR_VOLTAGE_SCALE1);

    /** 
    * 开启系统的时钟源，并配置相应值
    * PLL依赖HAE, RTC工作采用LSE，IWDG采用LSI, 所以这些时钟需求开启
    * LSE Clock: 32.768KHz
    * LSI Clock: 32KHz
    * HSE Clock: 25MHz
    * System CLock: 25 / PLLM * PLLN / PLLP = 180MHz
    */
    RCC_OscInitStruct.OscillatorType = RCC_OSCILLATORTYPE_LSI|RCC_OSCILLATORTYPE_HSE
                          |RCC_OSCILLATORTYPE_LSE;

    //因为HSE和LSE使用的都是无源晶振，因此非旁路，配置为RCC_HSE_ON
    //如果使用有源晶振，修改为RCC_HSE_BYPASS
    RCC_OscInitStruct.HSEState = RCC_HSE_ON;
    RCC_OscInitStruct.LSEState = RCC_LSE_ON;
    RCC_OscInitStruct.LSIState = RCC_LSI_ON;
    RCC_OscInitStruct.PLL.PLLState = RCC_PLL_ON;
    RCC_OscInitStruct.PLL.PLLSource = RCC_PLLSOURCE_HSE;
    RCC_OscInitStruct.PLL.PLLM = 25;
    RCC_OscInitStruct.PLL.PLLN = 360;
    RCC_OscInitStruct.PLL.PLLP = RCC_PLLP_DIV2;
    RCC_OscInitStruct.PLL.PLLQ = 8;
    if (HAL_RCC_OscConfig(&RCC_OscInitStruct) != HAL_OK)
    {
        Error_Handler();
    }

    /** Activate the Over-Drive mode
    */
    if (HAL_PWREx_EnableOverDrive() != HAL_OK)
    {
        Error_Handler();
    }

    /** Initializes the CPU, AHB and APB buses clocks
    * SYSTICK Clock - PLL Clock 180MHz
    * AHB Clock - SYSTICK Clock/DIV 180MHz
    * APB1 Clock - AHB Clock/4 45MHz
    * APB2 Clock - AHB Clock/2 90MHz
    */
    RCC_ClkInitStruct.ClockType = RCC_CLOCKTYPE_HCLK|RCC_CLOCKTYPE_SYSCLK
                            |RCC_CLOCKTYPE_PCLK1|RCC_CLOCKTYPE_PCLK2;
    RCC_ClkInitStruct.SYSCLKSource = RCC_SYSCLKSOURCE_PLLCLK;
    RCC_ClkInitStruct.AHBCLKDivider = RCC_SYSCLK_DIV1;
    RCC_ClkInitStruct.APB1CLKDivider = RCC_HCLK_DIV4;
    RCC_ClkInitStruct.APB2CLKDivider = RCC_HCLK_DIV2;

    if (HAL_RCC_ClockConfig(&RCC_ClkInitStruct, FLASH_LATENCY_5) != HAL_OK)
    {
        Error_Handler();
    }
```
## **2.2 外设模块时钟管理**
RCC模块提供其它外设的模块管理功能，通过RCC_APBxRSTR, RCC_AHBxRSTR, RCC_APBxENR, RCC_AHBxENR寄存器，可以控制大部分外设的模块使能/关闭和复位/非复位功能，这些在HAL库中被封装成宏进行操作, 下面举例来列出些接口说明。
```c
//使能GPIOA的时钟
__HAL_RCC_GPIOA_CLK_ENABLE();

//关闭GPIOA的时钟
__HAL_RCC_GPIOA_CLK_DISABLE();

//复位GPIOA模块
__HAL_RCC_GPIOA_FORCE_RESET();

//释放GPIOA模块复位
__HAL_RCC_GPIOA_RELEASE_RESET();
```
上述就是RCC提供的用于模块时钟管理接口，对于后续使用的外设，如SPI，I2C，Timer等，都需要进行相应的时钟使能和控制，了解时钟模块，对于模块的问题排查也具有重要意义。