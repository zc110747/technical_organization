# **6. DAC模块**
DAC模块是12位电压输出数模转换器，支持两路DAC输出，对应硬件DAC1-PA4, DAC2-PA5, 其中数据写入可以8位右对齐，12位左对齐和右对齐方式。在理解这三种方式的区别之前，先说明下DAC的计算，DAC输出电压的公式为: DACoutput = Vref\*DOR_REG/4096; 其中Vref是模拟参考电压输入，由外部电源提供(但要求1.8V和VDDA之间)，DOR_REG是通道输出寄存器值(12bit, 只读，由芯片自动移动从保持寄存器写入)。<br />
1. 8位右对齐，数据加载到DHR8R[7:0], 被移动到在DOR_REG的[11:4]位。**公式转换为: DACoutput = Vref\*(DHR8R<<4)/4096 = Vref\*DHR8R/256**, 这就转换成了8位有效的DAC。<br />
2. 12位左对齐, 数据加载到DHR12L[15:4], 被移动到DOR_REG的[11:0]位, **公式转换为:DACoutput = Vref\*(DHR12L>>4)/4096 = Vref\*DHR12L/2^16**, 这就转换成了16位有效的DAC, 这在音频控制DAC输出有重要意义，转换后的是16bit数据，对于有效位只有12bit的DAC，就需要进行数据右移，丢掉后4bit，这样处理就直接硬件完成，提高了效率。<br />
3. 12位右对齐，数据加载到DHR12R[11:0], 被移动到DOR_REG的[11:0]位, 不需要任何处理，**公式转换为: DACoutput = Vref\*DHR12R/4096**。<br />

了解了这些，基本上对于DAC的常用操作就有了认识，另外下面还有几个知识点。<br />

1. DAC支持输出缓冲器(buffer)，可以在不增加外部运放的情况下降低输出阻抗来驱动外部负载，如果有一定的带载要求需要打开。
2. DAC支持生成噪声和三角波，直接软件打开后会耦合到现有DAC输出上，需要在使能DAC之前配置。
3. DAC支持多种触发方式，定时器，外部中断，软件触发等，可通过DAC_CR寄存器配置。
4. DAC支持DMA控制输出，可通过定时器触发+DMA+DAC来实现音频的输出。
5. 对于Vref基准电压，虽然一般是LDO输出，如果只是用来测试没有问题，不过如果用于精确控制，就需要进行读取校准，这部分在ADC章节进行详细说明。

## **6.1 DAC模块配置**
了解了DAC上述只是，DAC的配置就比较简单，下面是基于HAL库的实现。
```c
//初始化DAC模块
static BaseType_t dac_hardware_init()
{
    DAC_ChannelConfTypeDef sConfig = {0};

    //初始化DAC模块
    dac_handle_.Instance = DAC;
    if(HAL_DAC_Init(&dac_handle_) != HAL_OK)
        return pdFAIL;
    
    //配置DAC通道，选择通道1
    sConfig.DAC_Trigger = DAC_TRIGGER_NONE;                 //定义触发源，软件触发
    sConfig.DAC_OutputBuffer = DAC_OUTPUTBUFFER_ENABLE;     //开启输出缓存器
    if(HAL_DAC_ConfigChannel(&dac_handle_, &sConfig, DAC_CHANNEL_1) != HAL_OK)
        return pdFAIL;
    
    return pdPASS;
}

//初始化DAC对应的GPIO
void HAL_DAC_MspInit(DAC_HandleTypeDef* hdac)
{
  GPIO_InitTypeDef GPIO_InitStruct = {0};
  if(hdac->Instance==DAC)
  {
    //enable clock
    __HAL_RCC_DAC_CLK_ENABLE();

    __HAL_RCC_GPIOA_CLK_ENABLE();
    /**DAC GPIO Configuration
    PA4     ------> DAC_OUT1
    */
    GPIO_InitStruct.Pin = GPIO_PIN_4;
    GPIO_InitStruct.Mode = GPIO_MODE_ANALOG;
    GPIO_InitStruct.Pull = GPIO_NOPULL;
    HAL_GPIO_Init(GPIOA, &GPIO_InitStruct);
}
```
初始化完成后，就可以设置输出电压了，因为DAC是基于基准电压分档，所以无法高于Vref，则接口如下。
```c
//reference voltage, uint:mv
#define DAC_REFERENCE_VOL   3300

//dac max output value
#define DAC_MAX_VALUE       4096

void dac_set_voltage(uint16_t mv)
{
    float adc_value;
    
    if(mv > DAC_REFERENCE_VOL)
        mv = DAC_REFERENCE_VOL;
    
    adc_value = (float)mv/DAC_REFERENCE_VOL * DAC_MAX_VALUE;
    
    //HAL_DAC_Stop(&dac_handle_, DAC_CHANNEL_1);
    HAL_DAC_SetValue(&dac_handle_, DAC_CHANNEL_1, DAC_ALIGN_12B_R, (uint32_t)adc_value); 
    HAL_DAC_Start(&dac_handle_, DAC_CHANNEL_1);
}
```
如此，通过dac_set_voltage设置电压，单位mv.



